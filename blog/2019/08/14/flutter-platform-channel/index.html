<!DOCTYPE html>
<html lang=&#34;en&#34; data-theme=&#34;&#34;>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="text/javascript">/*<![CDATA[*/window.__chunkMapping={"main":["/main.c96f282b900a0b52042c.css","/main.c96f282b900a0b52042c.js"],"component---users-zhaoyan-documents-project-fluttercn-dev-src-pages-index-js-85-a-818":["/component---users-zhaoyan-documents-project-fluttercn-dev-src-pages-index-js-85-a-818.4945fdd399e2e4cd3638.css","/component---users-zhaoyan-documents-project-fluttercn-dev-src-pages-index-js-85-a-818.4945fdd399e2e4cd3638.js"],"metadata---fd-8-5f3":["/metadata---fd-8-5f3.5afc354b757ed75e02c0.js"],"component---theme-blog-post-pageccc-cab":[],"content---blog-2019-08-14-flutter-platform-channel-245-7ae":["/content---blog-2019-08-14-flutter-platform-channel-245-7ae.422de328a218d9414da6.js"],"metadata---blog-2019-08-14-flutter-platform-channel-8-ef-2e2":["/metadata---blog-2019-08-14-flutter-platform-channel-8-ef-2e2.48be2e8936c6bae9c063.js"],"nextItem---blog-2019-08-14-flutter-platform-channel-72-f-689":["/nextItem---blog-2019-08-14-flutter-platform-channel-72-f-689.36393d7d44adf2a27924.js"],"content---blog-2019-08-11-flutter-rendercc-3-7dd":["/content---blog-2019-08-11-flutter-rendercc-3-7dd.9c618974b67616ee0108.js"],"nextItem---blog-2019-08-11-flutter-render-1-b-0-118":["/nextItem---blog-2019-08-11-flutter-render-1-b-0-118.a67d4c5a2d14092242f7.js"],"content---blog-2019-08-09-flutter-platform-view-681-1e6":["/content---blog-2019-08-09-flutter-platform-view-681-1e6.c826fd7e5325017ce8ae.js"],"nextItem---blog-2019-08-09-flutter-platform-viewc-00-0b8":["/nextItem---blog-2019-08-09-flutter-platform-viewc-00-0b8.305da2bdd7de4bcf04ee.js"],"content---blog-2019-07-29-flutter-image-7-ce-0ee":["/content---blog-2019-07-29-flutter-image-7-ce-0ee.7acac2eff8966331ad1c.js"],"nextItem---blog-2019-07-29-flutter-image-018-dd6":["/nextItem---blog-2019-07-29-flutter-image-018-dd6.7966bbc5850fa453fa70.js"],"content---blog-2019-07-23-flutter-text-823-fb9":["/content---blog-2019-07-23-flutter-text-823-fb9.fa7dd0f2ceafb78e63f8.js"],"nextItem---blog-2019-07-23-flutter-textc-01-5e3":["/nextItem---blog-2019-07-23-flutter-textc-01-5e3.7e46d2660ad687ce4b64.js"],"content---blog-2019-07-16-dart-basis-4-ff-3-b58":["/content---blog-2019-07-16-dart-basis-4-ff-3-b58.d98c5ba60f3518f9baf2.js"],"nextItem---blog-2019-07-16-dart-basis-460-a-740":["/nextItem---blog-2019-07-16-dart-basis-460-a-740.cd167e46e20300935896.js"],"content---blog-2019-07-15-dart-basis-327-c-47d":["/content---blog-2019-07-15-dart-basis-327-c-47d.c05062c0a05ff3ee4118.js"],"nextItem---blog-2019-07-15-dart-basis-3693-6a6":["/nextItem---blog-2019-07-15-dart-basis-3693-6a6.e226dd9e0a66efb25839.js"],"content---blog-2019-07-14-dart-basis-20-d-2-195":["/content---blog-2019-07-14-dart-basis-20-d-2-195.3c1cef2a82f7141cb915.js"],"nextItem---blog-2019-07-14-dart-basis-23-f-7-349":["/nextItem---blog-2019-07-14-dart-basis-23-f-7-349.39ca72f55dc8ff9ea4d8.js"],"content---blog-2019-07-13-dart-basis-1337-367":["/content---blog-2019-07-13-dart-basis-1337-367.b7e68aa5c096266a875b.js"],"nextItem---blog-2019-07-13-dart-basis-15-b-8-ccc":["/nextItem---blog-2019-07-13-dart-basis-15-b-8-ccc.0c3c1fef1239ec93e016.js"],"content---blog-2019-07-12-flutter-widget-videosb-80-447":["/content---blog-2019-07-12-flutter-widget-videosb-80-447.53848ae015081cd1e750.js"],"component---theme-doc-legacy-page-9-e-7-ca5":[],"docsMetadata---docs-7-f-7-bea":["/docsMetadata---docs-7-f-7-bea.5454495baf8d44a46b95.js"],"component---theme-doc-legacy-item-031-769":[],"content---docs-doc-1485-ea9":["/content---docs-doc-1485-ea9.91a21120b62deaa378a9.js"],"metadata---docs-doc-1938-69f":["/metadata---docs-doc-1938-69f.d0d14fb35db6e65d774c.js"],"content---docs-doc-23-da-2dd":["/content---docs-doc-23-da-2dd.74ded79c1db0d94cf327.js"],"metadata---docs-doc-203-b-f35":["/metadata---docs-doc-203-b-f35.13716f117b9af435092c.js"],"content---docs-doc-38-b-3-af8":["/content---docs-doc-38-b-3-af8.ad4df2a5aa083e103a8a.js"],"metadata---docs-doc-3-f-8-f-df4":["/metadata---docs-doc-3-f-8-f-df4.e4d8d0854ec66ec94fdc.js"],"content---docs-mdx-0-bf-16e":["/content---docs-mdx-0-bf-16e.3e02d3758d1e727a3b92.js"],"metadata---docs-mdx-96-d-0f3":["/metadata---docs-mdx-96-d-0f3.984c5c2ec701793d14ed.js"],"component---theme-blog-list-pagea-6-a-7ba":[],"content---blog-931-68c":["/content---blog-931-68c.d381a15cfdf2f8b4b27b.js"],"content---blogabb-fcf":["/content---blogabb-fcf.86570279aa281ca9814c.js"],"content---blog-46-c-a0c":["/content---blog-46-c-a0c.a9492727a63bf3db64a1.js"],"content---blog-063-c18":["/content---blog-063-c18.fa065d9d66e1f230a709.js"],"content---blogb-3-a-97e":["/content---blogb-3-a-97e.282155ac79d643b972b0.js"],"content---blogf-92-898":["/content---blogf-92-898.27ae9b412791ffefd4cd.js"],"content---blog-84-f-da8":["/content---blog-84-f-da8.ca2fddf3ae1025faff64.js"],"content---blog-536-6e8":["/content---blog-536-6e8.faa4b76d93a6a4176f86.js"],"content---blogb-00-8ad":["/content---blogb-00-8ad.903297a81cec3b7f5ff8.js"],"content---blog-5-fc-b56":["/content---blog-5-fc-b56.ac520e3c8937dc1e440e.js"],"metadata---blog-042-006":["/metadata---blog-042-006.8a79ab629010cc3232dd.js"],"component---theme-blog-tags-posts-page-687-b6c":[],"metadata---blog-tags-flutterdd-5-77c":["/metadata---blog-tags-flutterdd-5-77c.ab38a18272a314cea6f3.js"],"metadata---blog-tags-platform-view-400-357":["/metadata---blog-tags-platform-view-400-357.7fe26a61135d953d96b1.js"],"metadata---blog-tags-widget-927-27f":["/metadata---blog-tags-widget-927-27f.902439de6db73ecced82.js"],"metadata---blog-tags-dart-59-e-f7a":["/metadata---blog-tags-dart-59-e-f7a.2f8ad5cb6a60cb8cb2a6.js"],"metadata---blog-tags-basic-03-d-932":["/metadata---blog-tags-basic-03-d-932.fa56c7cac3d05d91fe45.js"],"metadata---blog-tags-videoc-18-4f1":["/metadata---blog-tags-videoc-18-4f1.469d855d5e790e8d9308.js"],"component---theme-blog-tags-list-page-01-a-d0b":[],"tags---blog-tagsac-5-ed9":["/tags---blog-tagsac-5-ed9.6e28d213d5e2d6574e43.js"]};/*]]>*/</script>

<title data-react-helmet="true">Flutter Platform Channel 使用与源码分析</title>

<meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="viewport" content="width=device-width"/><meta data-react-helmet="true" property="og:title" content="Flutter Platform Channel 使用与源码分析"/><meta data-react-helmet="true" name="description" content="### 1. 为什么要有 PlatformChannel"/><meta data-react-helmet="true" property="og:description" content="### 1. 为什么要有 PlatformChannel"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/>

<link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.png"/>


<link rel="stylesheet" type="text/css" href="/main.c96f282b900a0b52042c.css" />

<link rel="stylesheet" type="text/css" href="/component---users-zhaoyan-documents-project-fluttercn-dev-src-pages-index-js-85-a-818.4945fdd399e2e4cd3638.css" />

<link rel="stylesheet" type="text/css" href="/docusaurus.c6059712e04a5824f5a6.css" />

</head>
<body >
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a aria-current="page" class="navbar__brand active" href="/"><img class="navbar__logo" src="/img/favicon.png" alt="Flutter-Fans Logo"/><strong>Flutter-Fans</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" label="Blog" position="left" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle displayOnlyInLargeViewport_1gtMWLzW"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_16vChPFo moon_1N64xB5S"></span></div><div class="react-toggle-track-x"><span class="toggle_16vChPFo sun_3CZP6R61"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"/></div></div></div><div role="presentation" class="navbar__sidebar__backdrop"></div><div class="navbar__sidebar"><div class="navbar__sidebar__brand"><a aria-current="page" class="navbar__brand active" href="/"><img class="navbar__logo" src="/img/favicon.png" alt="Flutter-Fans Logo"/><strong>Flutter-Fans</strong></a></div><div class="navbar__sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" label="Blog" position="left" href="/blog">Blog</a></li></ul></div></div></div></nav><div class="container margin-vert--xl"><div class="row"><div class="col col--8 col--offset-2"><div><header><h1 class="margin-bottom--xs"><a aria-current="page" class="active" href="/blog/2019/08/14/flutter-platform-channel">Flutter Platform Channel 使用与源码分析</a></h1><div class="margin-bottom--sm"><small>August<!-- --> <!-- -->14<!-- -->, <!-- -->2019</small></div><div class="avatar margin-bottom--md"><a class="avatar__photo-link" href="https://github.com/77Y" target="_blank" rel="noreferrer noopener"><img class="avatar__photo" src="https://avatars2.githubusercontent.com/u/5173695?s=460&amp;v=4" alt="yangpeng"/></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/77Y" target="_blank" rel="noreferrer noopener">yangpeng</a></h4><small class="avatar__subtitle">A flutter fans</small></div></div></header><article class="markdown"><h3><a aria-hidden="true" class="anchor" id="1-为什么要有-platformchannel"></a><a aria-hidden="true" class="hash-link" href="#1-为什么要有-platformchannel">#</a>1. 为什么要有 PlatformChannel</h3><p>1、如果 Flutter 要获取设备的电量信息怎么办？<br/>
<!-- -->2、如果 Flutter 要实时监控网络状态怎么办？</p><p>由于 Flutter 特点如下：</p><blockquote><p>Flutter is Google’s UI toolkit for building beautiful, natively compiled applications for mobile, web, and desktop from a single codebase.</p></blockquote><p>1、Flutter 是一个跨平台的 UI 库，专注于构建高效的 UI。<br/>
<!-- -->2、多平台的支持，下图是 Flutter 目前支持的平台，每个平台的都有自己的平台特性。</p><p><img src="http://p0.qhimg.com/t01b3f704dcfed0e4ab.png"/></p><p>基于以上两点，目前 Flutter 如果要和平台相关的部分通信需要有一个通道即 PlatformChannel。</p><h3><a aria-hidden="true" class="anchor" id="2-架构图"></a><a aria-hidden="true" class="hash-link" href="#2-架构图">#</a>2. 架构图</h3><p><img src="https://flutter.dev/images/PlatformChannels.png"/></p><h3><a aria-hidden="true" class="anchor" id="3-platformchannel-类型"></a><a aria-hidden="true" class="hash-link" href="#3-platformchannel-类型">#</a>3. PlatformChannel 类型</h3><ul><li>BasicMessageChannel：用于数据传递。platform 和 dart 可互相传递数据（asynchronous message passing）</li><li>MethodChannel：用于传递方法调用。platform 和 dart 可互相调用方法（asynchronous method calls）</li><li>EventChannel：用于数据流通信。建立连接之后，platform 发送消息，dart 接收消息（event streams）</li></ul><p>三种类型的 channel 都定义在 <code>platform_channel.dart</code> 中，从源码中可以看到三种 channel 都用到了以下三个属性。</p><ul><li><code>name</code>：String 类型，表示 channel 的名字，全局唯一（The logical channel on which communication happens）</li><li><code>codec</code>：MessageCodec 类型，消息的编码解码器（The message codec used by this channel）</li><li><code>binaryMessenger</code>：BinaryMessenger类型，用于发送数据（The messenger used by this channel to send platform messages）</li></ul><h4><a aria-hidden="true" class="anchor" id="31-channel-name"></a><a aria-hidden="true" class="hash-link" href="#31-channel-name">#</a>3.1 channel name</h4><p>channel 的名字，每个 Flutter 应用可能有多个 channel，但是每个 channel 必须有一个唯一的名字。</p><h4><a aria-hidden="true" class="anchor" id="32-codec"></a><a aria-hidden="true" class="hash-link" href="#32-codec">#</a>3.2 codec</h4><p>codec 用来对数据编码解码，以便两端可以正确读取数据。
<img src="http://p0.qhimg.com/t01d0c790e129c2c8f9.png"/></p><h4><a aria-hidden="true" class="anchor" id="33-binarymessenger"></a><a aria-hidden="true" class="hash-link" href="#33-binarymessenger">#</a>3.3 binaryMessenger</h4><p>用于发送数据</p><h3><a aria-hidden="true" class="anchor" id="4-platformchannel-使用"></a><a aria-hidden="true" class="hash-link" href="#4-platformchannel-使用">#</a>4. PlatformChannel 使用</h3><h4><a aria-hidden="true" class="anchor" id="41-methodchannel"></a><a aria-hidden="true" class="hash-link" href="#41-methodchannel">#</a>4.1 MethodChannel</h4><ul><li>Dart 调用 Android 方法</li></ul><p>method_channel_page.dart 主要代码</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-dart codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">第一步</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">static const methodChannel = MethodChannel(&quot;method_channel_sample&quot;);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">第二步  </span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">Future&lt;dynamic&gt; getUserInfo(String method, {String userName}) async {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  return await methodChannel.invokeMethod(method, userName);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">第三步    </span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">MaterialButton(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  color: Colors.blue,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  textColor: Colors.white,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  child: new Text(&#x27;获取 snow 用户信息&#x27;),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  onPressed: () {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    getUserInfo(&quot;getInfo&quot;, userName: &quot;snow&quot;)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      ..then((result) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        setState(() {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">          messageFromNative = result;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        });</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      });</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  },</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">),</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>MainActivity.java 主要代码</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-java codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">addMethodChannel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    mMethodChannel </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">MethodChannel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">getFlutterView</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;method_channel_sample&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    mMethodChannel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">setMethodCallHandler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">methodCall</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token class-name" style="color:rgb(255, 203, 139)">String</span><span class="token plain"> method </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> methodCall</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">method</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;getInfo&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">equals</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">method</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token class-name" style="color:rgb(255, 203, 139)">String</span><span class="token plain"> userName </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token class-name" style="color:rgb(255, 203, 139)">String</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> methodCall</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">userName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">equals</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;rocx&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                </span><span class="token class-name" style="color:rgb(255, 203, 139)">String</span><span class="token plain"> user </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;name:rocx, age:18&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                result</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">success</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                result</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">success</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;user not found&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                </span><span class="token function" style="color:rgb(130, 170, 255)">invokeSayHelloMethod</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>从以上代码可以看出
Dart 调用 Android 代码分三步。首先在 Dart 端定义 MethodChannel 名字为 <code>method_channel_sample</code>。然后定义<code>getUserInfo</code>方法，传入要调用的方法名和参数。最后点击按钮执行方法，获取用户信息。
在 Android 端定一个 MethodChannel 名字和 Dart 端保持一致。设置 MethodCallHandler。当调用的是<code>getInfo</code>方法时，根据参数返回信息。</p><ul><li>Android 调用 Dart 方法</li></ul><p>MainActivity.java 主要代码</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-java codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">invokeSayHelloMethod</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    mMethodChannel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">invokeMethod</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;sayHello&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">MethodChannel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token class-name" style="color:rgb(255, 203, 139)">Result</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token annotation punctuation" style="color:rgb(199, 146, 234)">@Override</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token keyword" style="color:rgb(127, 219, 202)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">success</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token class-name" style="color:rgb(255, 203, 139)">Object</span><span class="token plain"> o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token class-name" style="color:rgb(255, 203, 139)">Toast</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">makeText</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token class-name" style="color:rgb(255, 203, 139)">MainActivity</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">toString</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">Toast</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">LENGTH_LONG</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">show</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token annotation punctuation" style="color:rgb(199, 146, 234)">@Override</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token keyword" style="color:rgb(127, 219, 202)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">error</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token class-name" style="color:rgb(255, 203, 139)">String</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">String</span><span class="token plain"> s1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">Object</span><span class="token plain"> o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token annotation punctuation" style="color:rgb(199, 146, 234)">@Override</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token keyword" style="color:rgb(127, 219, 202)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">notImplemented</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>method_channel_page.dart 主要代码</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-dart codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">Future&lt;dynamic&gt; addHandler(MethodCall call) async {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  switch (call.method) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    case &quot;sayHello&quot;:</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      return &quot;Hello from Flutter&quot;;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      break;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">@override</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">void initState() {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  super.initState();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  methodChannel.setMethodCallHandler(addHandler);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>从代码可以看出，在 Dart 端设置 MethodCallHandler 然后在 Android 端调用即可。</p><h4><a aria-hidden="true" class="anchor" id="42-basicmessagechannel"></a><a aria-hidden="true" class="hash-link" href="#42-basicmessagechannel">#</a>4.2 BasicMessageChannel</h4><ul><li>Dart 向 Android 发送消息</li></ul><p>basic_message_channel_page.dart 主要代码</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-dart codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">第一步</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">static const basicMessageChannel = BasicMessageChannel(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      &quot;basic_message_channel_sample&quot;, StandardMessageCodec());</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">第二步</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">Future&lt;dynamic&gt; sayHelloToNative(String message) async {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  String reply = await basicMessageChannel.send(message);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  setState(() {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    msgReplyFromNative = reply;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  });</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  return reply;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">第三步</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">MaterialButton(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  color: Colors.blue,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  textColor: Colors.white,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  child: new Text(&#x27;say hello to native&#x27;),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  onPressed: () {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    sayHelloToNative(&quot;hello&quot;);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  },</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">),</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>MainActivity.java 主要代码</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-java codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">addBasicMessageChannel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    mBasicMessageChannel </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">BasicMessageChannel</span><span class="token generics punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token generics punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">getFlutterView</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;basic_message_channel_sample&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">StandardMessageCodec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">INSTANCE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    mBasicMessageChannel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">setMessageHandler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">object</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> reply</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        reply</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">reply</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;receive &quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> object</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">toString</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot; from flutter&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        mBasicMessageChannel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">send</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;native say hello to flutter&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>从以上代码可以看出
Dart 向 Android 发送消息依然分为三步。首先在 Dart 端定义 BasicMessageChannel 名字为 <code>basic_message_channel_sample</code>。然后定义发送消息的方法<code>sayHelloToNative</code>。最后点击按钮向 Android 端发送消息。
在 Android 端定一个 BasicMessageChannel 名字和 Dart 端保持一致。设置 MethodCallHandler。当收到消息时发一个回复。</p><ul><li>Android 向 Dart 发送消息</li></ul><p>MainActivity.java 主要代码</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-java codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">mBasicMessageChannel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">send</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;native say hello to flutter&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>basic_message_channel_page.dart 主要代码</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-dart codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">Future&lt;dynamic&gt; addHandler(Object result) async {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  setState(() {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    msgReceiveFromNative = result.toString();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  });</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">void addMessageListener() {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  basicMessageChannel.setMessageHandler(addHandler);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">@override</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">void initState() {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  super.initState();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  addMessageListener();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>从代码可以看出，在 Dart 端设置 MessageHandler 然后在 Android 端直接发送消息即可。</p><h4><a aria-hidden="true" class="anchor" id="43-eventchannel"></a><a aria-hidden="true" class="hash-link" href="#43-eventchannel">#</a>4.3 EventChannel</h4><p>event_channel_page.dart 主要代码</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-dart codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">第一步</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">static const eventChannel = EventChannel(&quot;event_channel_sample&quot;);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">void _onEvent(Object event) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  setState(() {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if (_streamSubscription != null) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      eventMessage = event.toString();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  });</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">void _onError(Object error) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  setState(() {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if (_streamSubscription != null) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      eventMessage = &quot;error&quot;;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  });</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">@override</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">void initState() {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  super.initState();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  eventMessage = &quot;&quot;;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  第二步</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  _streamSubscription = eventChannel</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      .receiveBroadcastStream()</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      .listen(_onEvent, onError: _onError);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>MainActivity.java 主要代码</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-java codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">addEventChannel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    mEventChannel </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">EventChannel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">getFlutterView</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;event_channel_sample&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    mEventChannel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">setStreamHandler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">EventChannel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token class-name" style="color:rgb(255, 203, 139)">StreamHandler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token annotation punctuation" style="color:rgb(199, 146, 234)">@Override</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token keyword" style="color:rgb(127, 219, 202)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">onListen</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token class-name" style="color:rgb(255, 203, 139)">Object</span><span class="token plain"> o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">EventChannel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token class-name" style="color:rgb(255, 203, 139)">EventSink</span><span class="token plain"> eventSink</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            task </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">TimerTask</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                </span><span class="token annotation punctuation" style="color:rgb(199, 146, 234)">@Override</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                </span><span class="token keyword" style="color:rgb(127, 219, 202)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">run</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                    </span><span class="token function" style="color:rgb(130, 170, 255)">runOnUiThread</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">-&gt;</span><span class="token plain"> eventSink</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">success</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;i miss you &quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">System</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">currentTimeMillis</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            timer </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">Timer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            timer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">schedule</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token annotation punctuation" style="color:rgb(199, 146, 234)">@Override</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token keyword" style="color:rgb(127, 219, 202)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">onCancel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token class-name" style="color:rgb(255, 203, 139)">Object</span><span class="token plain"> o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">cancel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            timer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">cancel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            task </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            timer </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>Dart 接受 Android stream event。首先在 Dart 端定义 EventChannel 名字为 <code>event_channel_sample</code>。然后设置<code>receiveBroadcastStream</code>监听，当 Android 端有消息发过来会回调<code>_onEvent</code>方法。
在 Android 端启动一个定时器，每隔3s向 Dart 端发送一次消息。</p><h4><a aria-hidden="true" class="anchor" id="44-总结"></a><a aria-hidden="true" class="hash-link" href="#44-总结">#</a>4.4 总结</h4><p>如下图，在 Dart 与 Platform 通信过程中，通过 channel name 找到对方，然后把消息通过 codec 进行编解码，最后通过 binaryMessenger 进行发送。<br/>
<img src="http://p0.qhimg.com/t01d23cfd7ce4e80077.png"/></p><h3><a aria-hidden="true" class="anchor" id="5-源码分析-以-methodchannel-为例"></a><a aria-hidden="true" class="hash-link" href="#5-源码分析-以-methodchannel-为例">#</a>5. 源码分析-以 MethodChannel 为例</h3><h5><a aria-hidden="true" class="anchor" id="51-调用-methodchannel-的-invokemethod-方法，会调用到-binarymessengersend-方法。即-binarymessengersend-传入-channel-name-和编码好的参数。"></a><a aria-hidden="true" class="hash-link" href="#51-调用-methodchannel-的-invokemethod-方法，会调用到-binarymessengersend-方法。即-binarymessengersend-传入-channel-name-和编码好的参数。">#</a>5.1 调用 MethodChannel 的 invokeMethod 方法，会调用到 binaryMessenger.send 方法。即 binaryMessenger.send 传入 channel name 和编码好的参数。</h5><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-dart codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">@optionalTypeArgs</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  Future&lt;T&gt; invokeMethod&lt;T&gt;(String method, [ dynamic arguments ]) async {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    assert(method != null);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    final ByteData result = await binaryMessenger.send(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      name,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      codec.encodeMethodCall(MethodCall(method, arguments)),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    );</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if (result == null) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      throw MissingPluginException(&#x27;No implementation found for method $method on channel $name&#x27;);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    final T typedResult = codec.decodeEnvelope(result);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    return typedResult;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><h5><a aria-hidden="true" class="anchor" id="52-binary_messengerdart-的-send-方法会调用当前对象的-_sendplatformmessage-方法，最终会调用-windowsendplatformmessage-方法。"></a><a aria-hidden="true" class="hash-link" href="#52-binary_messengerdart-的-send-方法会调用当前对象的-_sendplatformmessage-方法，最终会调用-windowsendplatformmessage-方法。">#</a>5.2 binary_messenger.dart 的 send 方法会调用当前对象的 _sendPlatformMessage 方法，最终会调用 window.sendPlatformMessage 方法。</h5><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-dart codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">@override</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  Future&lt;ByteData&gt; send(String channel, ByteData message) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    final MessageHandler handler = _mockHandlers[channel];</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if (handler != null)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      return handler(message);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    return _sendPlatformMessage(channel, message);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-dart codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">Future&lt;ByteData&gt; _sendPlatformMessage(String channel, ByteData message) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    final Completer&lt;ByteData&gt; completer = Completer&lt;ByteData&gt;();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // ui.window is accessed directly instead of using ServicesBinding.instance.window</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // because this method might be invoked before any binding is initialized.</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // This issue was reported in #27541. It is not ideal to statically access</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // ui.window because the Window may be dependency injected elsewhere with</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // a different instance. However, static access at this location seems to be</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // the least bad option.</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    ui.window.sendPlatformMessage(channel, message, (ByteData reply) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      try {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        completer.complete(reply);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      } catch (exception, stack) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        FlutterError.reportError(FlutterErrorDetails(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">          exception: exception,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">          stack: stack,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">          library: &#x27;services library&#x27;,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">          context: ErrorDescription(&#x27;during a platform message response callback&#x27;),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        ));</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    });</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    return completer.future;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><h5><a aria-hidden="true" class="anchor" id="53-在-windowdart-中又调用了-native-方法-_sendplatformmessage。"></a><a aria-hidden="true" class="hash-link" href="#53-在-windowdart-中又调用了-native-方法-_sendplatformmessage。">#</a>5.3 在 window.dart 中又调用了 native 方法 _sendPlatformMessage。</h5><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-dart codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">void sendPlatformMessage(String name,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                           ByteData data,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                           PlatformMessageResponseCallback callback) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    final String error =</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        _sendPlatformMessage(name, _zonedPlatformMessageResponseCallback(callback), data);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if (error != null)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      throw Exception(error);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-dart codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">String _sendPlatformMessage(String name,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                              PlatformMessageResponseCallback callback,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                              ByteData data) native &#x27;Window_sendPlatformMessage&#x27;;</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><h5><a aria-hidden="true" class="anchor" id="54-接下来进入-engine-中的-windowcc，可以看到最终调用的是-dart_state-window-client-handleplatformmessage。"></a><a aria-hidden="true" class="hash-link" href="#54-接下来进入-engine-中的-windowcc，可以看到最终调用的是-dart_state-window-client-handleplatformmessage。">#</a>5.4 接下来进入 engine 中的 window.cc，可以看到最终调用的是 dart_state-&gt;window()-&gt;client()-&gt;HandlePlatformMessage。</h5><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-c++ codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">void Window::RegisterNatives(tonic::DartLibraryNatives* natives) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  natives-&gt;Register({</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      {&quot;Window_defaultRouteName&quot;, DefaultRouteName, 1, true},</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      {&quot;Window_scheduleFrame&quot;, ScheduleFrame, 1, true},</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      {&quot;Window_sendPlatformMessage&quot;, _SendPlatformMessage, 4, true},</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      {&quot;Window_respondToPlatformMessage&quot;, _RespondToPlatformMessage, 3, true},</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      {&quot;Window_render&quot;, Render, 2, true},</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      {&quot;Window_updateSemantics&quot;, UpdateSemantics, 2, true},</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      {&quot;Window_setIsolateDebugName&quot;, SetIsolateDebugName, 2, true},</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      {&quot;Window_reportUnhandledException&quot;, ReportUnhandledException, 2, true},</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      {&quot;Window_setNeedsReportTimings&quot;, SetNeedsReportTimings, 2, true},</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  });</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-c++ codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">void _SendPlatformMessage(Dart_NativeArguments args) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  tonic::DartCallStatic(&amp;SendPlatformMessage, args);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-c++ codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">Dart_Handle SendPlatformMessage(Dart_Handle window,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                                const std::string&amp; name,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                                Dart_Handle callback,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                                Dart_Handle data_handle) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  UIDartState* dart_state = UIDartState::Current();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  if (!dart_state-&gt;window()) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    return tonic::ToDart(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        &quot;Platform messages can only be sent from the main isolate&quot;);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  fml::RefPtr&lt;PlatformMessageResponse&gt; response;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  if (!Dart_IsNull(callback)) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    response = fml::MakeRefCounted&lt;PlatformMessageResponseDart&gt;(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        tonic::DartPersistentValue(dart_state, callback),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        dart_state-&gt;GetTaskRunners().GetUITaskRunner());</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  if (Dart_IsNull(data_handle)) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    dart_state-&gt;window()-&gt;client()-&gt;HandlePlatformMessage(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        fml::MakeRefCounted&lt;PlatformMessage&gt;(name, response));</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  } else {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    tonic::DartByteData data(data_handle);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    const uint8_t* buffer = static_cast&lt;const uint8_t*&gt;(data.data());</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    dart_state-&gt;window()-&gt;client()-&gt;HandlePlatformMessage(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        fml::MakeRefCounted&lt;PlatformMessage&gt;(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            name, std::vector&lt;uint8_t&gt;(buffer, buffer + data.length_in_bytes()),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            response));</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  return Dart_Null();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><blockquote><p><a href="https://github.com/flutter/engine/blob/master/lib/ui/window/window.cc">window.cc 源码</a></p></blockquote><h5><a aria-hidden="true" class="anchor" id="55-我们进入-windowh-中找到-client-其实是-windowclient。"></a><a aria-hidden="true" class="hash-link" href="#55-我们进入-windowh-中找到-client-其实是-windowclient。">#</a>5.5 我们进入 window.h 中找到 client 其实是 WindowClient。</h5><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-c++ codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">WindowClient* client() const { return client_; }</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><blockquote><p><a href="https://github.com/flutter/engine/blob/master/lib/ui/window/window.h">window.h 源码</a></p></blockquote><h5><a aria-hidden="true" class="anchor" id="56-在-runtime_controllerh-中可以看到-runtimecontroller-是-windowclient-的实际实现，调用的是-runtimecontroller-的-handleplatformmessage-方法。"></a><a aria-hidden="true" class="hash-link" href="#56-在-runtime_controllerh-中可以看到-runtimecontroller-是-windowclient-的实际实现，调用的是-runtimecontroller-的-handleplatformmessage-方法。">#</a>5.6 在 runtime_controller.h 中可以看到 RuntimeController 是 WindowClient 的实际实现，调用的是 RuntimeController 的 HandlePlatformMessage 方法。</h5><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-c++ codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">class RuntimeController final : public WindowClient {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">...</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // |WindowClient|</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  void HandlePlatformMessage(fml::RefPtr&lt;PlatformMessage&gt; message) override;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">...</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><blockquote><p><a href="https://github.com/flutter/engine/blob/78a8ca0f62b04fa49030ecdd2d91726c0639401f/runtime/runtime_controller.h">runtime_controller.h 源码</a></p></blockquote><h5><a aria-hidden="true" class="anchor" id="57-在-runtimecontrollercc-中，handleplatformmessage-调用了-client-的-handleplatformmessage-方法，client_-实际是代理对象-runtimedelegate。"></a><a aria-hidden="true" class="hash-link" href="#57-在-runtimecontrollercc-中，handleplatformmessage-调用了-client-的-handleplatformmessage-方法，client_-实际是代理对象-runtimedelegate。">#</a>5.7 在 runtime<em>controller.cc 中，HandlePlatformMessage 调用了 client</em> 的 HandlePlatformMessage 方法，client_ 实际是代理对象 RuntimeDelegate。</h5><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-c++ codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">void RuntimeController::HandlePlatformMessage(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    fml::RefPtr&lt;PlatformMessage&gt; message) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  client_.HandlePlatformMessage(std::move(message));</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-c++ codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">RuntimeDelegate&amp; p_client</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><blockquote><p><a href="https://github.com/flutter/engine/blob/78a8ca0f62b04fa49030ecdd2d91726c0639401f/runtime/runtime_controller.cc">runtime_controller.cc 源码</a></p></blockquote><h5><a aria-hidden="true" class="anchor" id="58-engineh-是-runtimedelegate-的具体实现类。"></a><a aria-hidden="true" class="hash-link" href="#58-engineh-是-runtimedelegate-的具体实现类。">#</a>5.8 engine.h 是 RuntimeDelegate 的具体实现类。</h5><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-c++ codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">class Engine final : public RuntimeDelegate {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">...</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // |RuntimeDelegate|</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  void HandlePlatformMessage(fml::RefPtr&lt;PlatformMessage&gt; message) override;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">...  </span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><blockquote><p><a href="https://github.com/flutter/engine/blob/78a8ca0f62b04fa49030ecdd2d91726c0639401f/shell/common/engine.h">engine.h 源码</a></p></blockquote><h5><a aria-hidden="true" class="anchor" id="59-enginecc-中调用了-delegate_-的-onenginehandleplatformmessage-方法。"></a><a aria-hidden="true" class="hash-link" href="#59-enginecc-中调用了-delegate_-的-onenginehandleplatformmessage-方法。">#</a>5.9 engine.cc 中调用了 delegate_ 的 OnEngineHandlePlatformMessage 方法。</h5><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-c++ codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">void Engine::HandlePlatformMessage(fml::RefPtr&lt;PlatformMessage&gt; message) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  if (message-&gt;channel() == kAssetChannel) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    HandleAssetPlatformMessage(std::move(message));</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  } else {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    delegate_.OnEngineHandlePlatformMessage(std::move(message));</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><blockquote><p><a href="https://github.com/flutter/engine/blob/78a8ca0f62b04fa49030ecdd2d91726c0639401f/shell/common/engine.cc">engine.cc 源码</a></p></blockquote><h5><a aria-hidden="true" class="anchor" id="510-shellh-是-engine-的代理。"></a><a aria-hidden="true" class="hash-link" href="#510-shellh-是-engine-的代理。">#</a>5.10 shell.h 是 Engine 的代理。</h5><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-c++ codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">// |Engine::Delegate|</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  void OnEngineHandlePlatformMessage(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      fml::RefPtr&lt;PlatformMessage&gt; message) override;</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><blockquote><p><a href="https://github.com/flutter/engine/blob/ed8e35c4cfe12f836133944c968e00ca52593d43/shell/common/shell.h">shell.h 源码</a></p></blockquote><h5><a aria-hidden="true" class="anchor" id="511-调用流程又进入了-shellcc-的-handleengineskiamessage-方法，把消费放到-taskrunner-中。"></a><a aria-hidden="true" class="hash-link" href="#511-调用流程又进入了-shellcc-的-handleengineskiamessage-方法，把消费放到-taskrunner-中。">#</a>5.11 调用流程又进入了 shell.cc 的 HandleEngineSkiaMessage 方法，把消费放到 TaskRunner 中。</h5><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-c++ codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">// |Engine::Delegate|</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">void Shell::OnEngineHandlePlatformMessage(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    fml::RefPtr&lt;PlatformMessage&gt; message) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  FML_DCHECK(is_setup_);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  FML_DCHECK(task_runners_.GetUITaskRunner()-&gt;RunsTasksOnCurrentThread());</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  if (message-&gt;channel() == kSkiaChannel) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    HandleEngineSkiaMessage(std::move(message));</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    return;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  task_runners_.GetPlatformTaskRunner()-&gt;PostTask(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      [view = platform_view_-&gt;GetWeakPtr(), message = std::move(message)]() {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        if (view) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">          view-&gt;HandlePlatformMessage(std::move(message));</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      });</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><blockquote><p><a href="https://github.com/flutter/engine/blob/ed8e35c4cfe12f836133944c968e00ca52593d43/shell/common/shell.cc">shell.cc 源码</a></p></blockquote><h5><a aria-hidden="true" class="anchor" id="512-当-task-执行是会调用-platform_view_androidh-的-handleplatformmessage-方法。"></a><a aria-hidden="true" class="hash-link" href="#512-当-task-执行是会调用-platform_view_androidh-的-handleplatformmessage-方法。">#</a>5.12 当 task 执行是会调用 platform_view_android.h 的 HandlePlatformMessage 方法。</h5><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-c++ codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">class PlatformViewAndroid final : public PlatformView {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">...</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // |PlatformView|</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  void HandlePlatformMessage(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      fml::RefPtr&lt;flutter::PlatformMessage&gt; message) override;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">...</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><blockquote><p><a href="https://github.com/flutter/engine/blob/56052c70afcbdff2d39d2af279fcc52666122dbf/shell/platform/android/platform_view_android.h">platform_view_android.h 源码</a> </p></blockquote><h5><a aria-hidden="true" class="anchor" id="513-在-platform_view_androidcc-的-handleplatformmessage-中，开始通过-jni-调用-java-端的方法，java_channel-即要找的-channel。"></a><a aria-hidden="true" class="hash-link" href="#513-在-platform_view_androidcc-的-handleplatformmessage-中，开始通过-jni-调用-java-端的方法，java_channel-即要找的-channel。">#</a>5.13 在 platform_view_android.cc 的 HandlePlatformMessage 中，开始通过 jni 调用 java 端的方法，java_channel 即要找的 channel。</h5><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-c++ codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">// |PlatformView|</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">void PlatformViewAndroid::HandlePlatformMessage(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    fml::RefPtr&lt;flutter::PlatformMessage&gt; message) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  JNIEnv* env = fml::jni::AttachCurrentThread();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  fml::jni::ScopedJavaLocalRef&lt;jobject&gt; view = java_object_.get(env);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  if (view.is_null())</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    return;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  int response_id = 0;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  if (auto response = message-&gt;response()) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    response_id = next_response_id_++;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    pending_responses_[response_id] = response;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  auto java_channel = fml::jni::StringToJavaString(env, message-&gt;channel());</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  if (message-&gt;hasData()) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    fml::jni::ScopedJavaLocalRef&lt;jbyteArray&gt; message_array(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        env, env-&gt;NewByteArray(message-&gt;data().size()));</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    env-&gt;SetByteArrayRegion(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        message_array.obj(), 0, message-&gt;data().size(),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        reinterpret_cast&lt;const jbyte*&gt;(message-&gt;data().data()));</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    message = nullptr;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // This call can re-enter in InvokePlatformMessageXxxResponseCallback.</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    FlutterViewHandlePlatformMessage(env, view.obj(), java_channel.obj(),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                                     message_array.obj(), response_id);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  } else {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    message = nullptr;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // This call can re-enter in InvokePlatformMessageXxxResponseCallback.</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    FlutterViewHandlePlatformMessage(env, view.obj(), java_channel.obj(),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                                     nullptr, response_id);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><blockquote><p><a href="https://github.com/flutter/engine/blob/56052c70afcbdff2d39d2af279fcc52666122dbf/shell/platform/android/platform_view_android.cc">platform_view_android.cc 源码</a></p></blockquote><h5><a aria-hidden="true" class="anchor" id="514-在-platform_view_android_jnicc-中可以看到-g_handle_platform_message_method-就是-findclassioflutterembeddingengineflutterjni-类的-handleplatformmessage-方法。至此-engine-代码执行结束。"></a><a aria-hidden="true" class="hash-link" href="#514-在-platform_view_android_jnicc-中可以看到-g_handle_platform_message_method-就是-findclassioflutterembeddingengineflutterjni-类的-handleplatformmessage-方法。至此-engine-代码执行结束。">#</a>5.14 在 platform_view_android_jni.cc 中可以看到 g_handle_platform_message_method 就是 FindClass(&quot;io/flutter/embedding/engine/FlutterJNI&quot;) 类的 handlePlatformMessage 方法。至此 engine 代码执行结束。</h5><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-c++ codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">static jmethodID g_handle_platform_message_method = nullptr;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">void FlutterViewHandlePlatformMessage(JNIEnv* env,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                                      jobject obj,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                                      jstring channel,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                                      jobject message,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                                      jint responseId) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  env-&gt;CallVoidMethod(obj, g_handle_platform_message_method, channel, message,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                      responseId);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  FML_CHECK(CheckException(env));</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-c++ codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">g_handle_platform_message_method =</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      env-&gt;GetMethodID(g_flutter_jni_class-&gt;obj(), &quot;handlePlatformMessage&quot;,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                       &quot;(Ljava/lang/String;[BI)V&quot;);</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-c++ codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">g_flutter_jni_class = new fml::jni::ScopedJavaGlobalRef&lt;jclass&gt;(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      env, env-&gt;FindClass(&quot;io/flutter/embedding/engine/FlutterJNI&quot;));</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  if (g_flutter_jni_class-&gt;is_null()) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    FML_LOG(ERROR) &lt;&lt; &quot;Failed to find FlutterJNI Class.&quot;;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    return false;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><blockquote><p><a href="https://github.com/flutter/engine/blob/ed8e35c4cfe12f836133944c968e00ca52593d43/shell/platform/android/platform_view_android_jni.cc">platform_view_android_jni.cc 源码</a></p></blockquote><h5><a aria-hidden="true" class="anchor" id="515-在-flutterjni-中调用了-thisplatformmessagehandlerhandlemessagefromdart-方法。也就是-dartmessenger-的-handlemessagefromdart-方法。"></a><a aria-hidden="true" class="hash-link" href="#515-在-flutterjni-中调用了-thisplatformmessagehandlerhandlemessagefromdart-方法。也就是-dartmessenger-的-handlemessagefromdart-方法。">#</a>5.15 在 FlutterJNI 中调用了 this.platformMessageHandler.handleMessageFromDart 方法。也就是 DartMessenger 的 handleMessageFromDart 方法。</h5><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-java codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">private</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">handlePlatformMessage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token annotation punctuation" style="color:rgb(199, 146, 234)">@NonNull</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">String</span><span class="token plain"> channel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">byte</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> message</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">int</span><span class="token plain"> replyId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">platformMessageHandler </span><span class="token operator" style="color:rgb(127, 219, 202)">!=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">platformMessageHandler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">handleMessageFromDart</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">channel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> replyId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><h5><a aria-hidden="true" class="anchor" id="516-dartmessenger-中-messagehandlers-通过-channel-名找到对应的-handler-进行处理，这个-handler-就是我们在-java-代码里通过-channel-设置的，整个调用流程完成。"></a><a aria-hidden="true" class="hash-link" href="#516-dartmessenger-中-messagehandlers-通过-channel-名找到对应的-handler-进行处理，这个-handler-就是我们在-java-代码里通过-channel-设置的，整个调用流程完成。">#</a>5.16 DartMessenger 中 messageHandlers 通过 channel 名找到对应的 handler 进行处理，这个 handler 就是我们在 java 代码里通过 channel 设置的，整个调用流程完成。</h5><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-java codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">handleMessageFromDart</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token annotation punctuation" style="color:rgb(199, 146, 234)">@NonNull</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">String</span><span class="token plain"> channel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token annotation punctuation" style="color:rgb(199, 146, 234)">@Nullable</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">byte</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> message</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">int</span><span class="token plain"> replyId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token class-name" style="color:rgb(255, 203, 139)">Log</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">v</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;DartMessenger&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Received message from Dart over channel &#x27;&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> channel </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;&#x27;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token class-name" style="color:rgb(255, 203, 139)">BinaryMessageHandler</span><span class="token plain"> handler </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token class-name" style="color:rgb(255, 203, 139)">BinaryMessageHandler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">messageHandlers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">get</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">channel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">handler </span><span class="token operator" style="color:rgb(127, 219, 202)">!=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token keyword" style="color:rgb(127, 219, 202)">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                </span><span class="token class-name" style="color:rgb(255, 203, 139)">Log</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">v</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;DartMessenger&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Deferring to registered handler to process message.&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                </span><span class="token class-name" style="color:rgb(255, 203, 139)">ByteBuffer</span><span class="token plain"> buffer </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> message </span><span class="token operator" style="color:rgb(127, 219, 202)">==</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">null</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">?</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">null</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">ByteBuffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">wrap</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">message</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">onMessage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">buffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">DartMessenger</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token class-name" style="color:rgb(255, 203, 139)">Reply</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">flutterJNI</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> replyId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token class-name" style="color:rgb(255, 203, 139)">Exception</span><span class="token plain"> var6</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                </span><span class="token class-name" style="color:rgb(255, 203, 139)">Log</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">e</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;DartMessenger&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Uncaught exception in binary message listener&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> var6</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                </span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">flutterJNI</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">invokePlatformMessageEmptyResponseCallback</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">replyId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token class-name" style="color:rgb(255, 203, 139)">Log</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">v</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;DartMessenger&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;No registered handler for message. Responding to Dart with empty reply message.&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">flutterJNI</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">invokePlatformMessageEmptyResponseCallback</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">replyId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><h3><a aria-hidden="true" class="anchor" id="demo-地址"></a><a aria-hidden="true" class="hash-link" href="#demo-地址">#</a>Demo 地址</h3><p><a href="https://github.com/roc-x/roc-samples/tree/master/flutter_platform_channel">flutter_platform_channel 使用</a></p><h3><a aria-hidden="true" class="anchor" id="参考资源"></a><a aria-hidden="true" class="hash-link" href="#参考资源">#</a>参考资源</h3><p><a href="https://flutter.dev/docs/development/platform-integration/platform-channels">Writing custom platform-specific code</a><br/>
<a href="https://github.com/flutter/flutter/tree/master/examples/platform_channel">platform channel 官方示例</a><br/>
<a href="https://www.yuque.com/xytech/flutter/fu7h25">深入理解Flutter Platform Channel</a></p></article><div class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/flutter">flutter</a><a class="margin-horiz--sm" href="/blog/tags/widget">widget</a></div><div class="col text--right"></div></div></div><div class="margin-vert--xl"><nav class="pagination-nav"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2019/08/11/flutter-render"><h5 class="pagination-nav__link--sublabel">Next Post</h5><h4 class="pagination-nav__link--label">Flutter 从加载到显示<!-- --> »</h4></a></div></nav></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="text--center">Copyright © 2019 Flutter-Fans. Built with Docusaurus.</div></div></footer>
</div>

<script type="text/javascript" src="/runtime~main.a812c55c962abd52891e.js"></script>

<script type="text/javascript" src="/main.c96f282b900a0b52042c.js"></script>

<script type="text/javascript" src="/vendors.7d2d565e7d925589e9f2.js"></script>

<script type="text/javascript" src="/react-helmet.8e7fdfe7a549fe294bcd.js"></script>

<script type="text/javascript" src="/prism-react-renderer.c8da09aeb9119d2dd62f.js"></script>

<script type="text/javascript" src="/component---users-zhaoyan-documents-project-fluttercn-dev-src-pages-index-js-85-a-818.4945fdd399e2e4cd3638.js"></script>

<script type="text/javascript" src="/docusaurus.c6059712e04a5824f5a6.js"></script>

<script type="text/javascript" src="/content---blog-2019-08-14-flutter-platform-channel-245-7ae.422de328a218d9414da6.js"></script>

<script type="text/javascript" src="/metadata---blog-2019-08-14-flutter-platform-channel-8-ef-2e2.48be2e8936c6bae9c063.js"></script>

<script type="text/javascript" src="/nextItem---blog-2019-08-14-flutter-platform-channel-72-f-689.36393d7d44adf2a27924.js"></script>

</body>
</html>