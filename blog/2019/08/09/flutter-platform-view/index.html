<!DOCTYPE html>
<html lang=&#34;en&#34; data-theme=&#34;&#34;>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="text/javascript">/*<![CDATA[*/window.__chunkMapping={"main":["/main.d2d39918c98151667102.css","/main.d2d39918c98151667102.js"],"component---users-wangjianbing-project-fluttercn-dev-src-pages-index-js-8-f-8-fe8":["/component---users-wangjianbing-project-fluttercn-dev-src-pages-index-js-8-f-8-fe8.26ff9bd308d6cd6104ae.css","/component---users-wangjianbing-project-fluttercn-dev-src-pages-index-js-8-f-8-fe8.26ff9bd308d6cd6104ae.js"],"metadata---a-64-e52":["/metadata---a-64-e52.c0e6ff2c92223f742413.js"],"component---theme-blog-post-pageccc-cab":[],"content---blog-2019-08-29-flutter-layout-and-paintcb-1-468":["/content---blog-2019-08-29-flutter-layout-and-paintcb-1-468.81c507b18d1af4d49e35.js"],"metadata---blog-2019-08-29-flutter-layout-and-paint-5-a-1-6a6":["/metadata---blog-2019-08-29-flutter-layout-and-paint-5-a-1-6a6.41e38edd7ec925629f29.js"],"nextItem---blog-2019-08-29-flutter-layout-and-paint-944-f1c":["/nextItem---blog-2019-08-29-flutter-layout-and-paint-944-f1c.f59edec7ecb8b282e887.js"],"content---blog-2019-08-14-flutter-platform-channel-0-fe-961":["/content---blog-2019-08-14-flutter-platform-channel-0-fe-961.c9b429a201fdf97386ad.js"],"nextItem---blog-2019-08-14-flutter-platform-channel-7-ed-a0b":["/nextItem---blog-2019-08-14-flutter-platform-channel-7-ed-a0b.79d39fc077891d5e758e.js"],"content---blog-2019-08-11-flutter-render-309-808":["/content---blog-2019-08-11-flutter-render-309-808.34e927cc8c7d64b58b97.js"],"nextItem---blog-2019-08-11-flutter-renderf-90-acb":["/nextItem---blog-2019-08-11-flutter-renderf-90-acb.02dd3735024dd8fe4d58.js"],"content---blog-2019-08-09-flutter-platform-view-31-b-d5a":["/content---blog-2019-08-09-flutter-platform-view-31-b-d5a.17a5ea4827cb268e132f.js"],"nextItem---blog-2019-08-09-flutter-platform-view-09-e-95e":["/nextItem---blog-2019-08-09-flutter-platform-view-09-e-95e.094efbc8d3ec82c87fc9.js"],"content---blog-2019-07-29-flutter-image-00-f-3c9":["/content---blog-2019-07-29-flutter-image-00-f-3c9.4b757f895a0667bdb0fc.js"],"nextItem---blog-2019-07-29-flutter-imagef-9-b-2cd":["/nextItem---blog-2019-07-29-flutter-imagef-9-b-2cd.456f3b355e8f76c4fa11.js"],"content---blog-2019-07-23-flutter-texte-7-f-5e3":["/content---blog-2019-07-23-flutter-texte-7-f-5e3.d7cf3e41022fb2832468.js"],"nextItem---blog-2019-07-23-flutter-text-491-9fd":["/nextItem---blog-2019-07-23-flutter-text-491-9fd.30da5206dc25c97fbc8a.js"],"content---blog-2019-07-16-dart-basis-4571-109":["/content---blog-2019-07-16-dart-basis-4571-109.2bbb759542b63b458006.js"],"nextItem---blog-2019-07-16-dart-basis-4-d-07-edf":["/nextItem---blog-2019-07-16-dart-basis-4-d-07-edf.5b2d8f1e65e421b15bae.js"],"content---blog-2019-07-15-dart-basis-3-de-0-611":["/content---blog-2019-07-15-dart-basis-3-de-0-611.15036f353fc20bf8aeb3.js"],"nextItem---blog-2019-07-15-dart-basis-3-c-72-cb6":["/nextItem---blog-2019-07-15-dart-basis-3-c-72-cb6.e42b62f38f5aa5b3c897.js"],"content---blog-2019-07-14-dart-basis-2401-3b5":["/content---blog-2019-07-14-dart-basis-2401-3b5.ac1782e7bc1845920336.js"],"nextItem---blog-2019-07-14-dart-basis-2074-310":["/nextItem---blog-2019-07-14-dart-basis-2074-310.d0fd640b5a28aa7075a0.js"],"content---blog-2019-07-13-dart-basis-11-d-6-128":["/content---blog-2019-07-13-dart-basis-11-d-6-128.509312cb7a25c16ff34e.js"],"nextItem---blog-2019-07-13-dart-basis-1220-dd2":["/nextItem---blog-2019-07-13-dart-basis-1220-dd2.6a4588d8964724c4e3fb.js"],"content---blog-2019-07-12-flutter-widget-videosc-9-f-72c":["/content---blog-2019-07-12-flutter-widget-videosc-9-f-72c.11f3d3096e7778fc0800.js"],"component---theme-doc-legacy-page-9-e-7-ca5":[],"docsMetadata---docs-219-f23":["/docsMetadata---docs-219-f23.b979fe6c0b877dd3b9fc.js"],"component---theme-doc-legacy-item-031-769":[],"content---docs-doc-1-d-42-e1f":["/content---docs-doc-1-d-42-e1f.c33ac082440776889803.js"],"metadata---docs-doc-187-a-aee":["/metadata---docs-doc-187-a-aee.61da9299a2e7ad0b03d9.js"],"content---docs-doc-2-c-2-e-e91":["/content---docs-doc-2-c-2-e-e91.351c157dcf37c63088aa.js"],"metadata---docs-doc-2-dc-7-408":["/metadata---docs-doc-2-dc-7-408.8481f7e36d2faae2fac4.js"],"content---docs-doc-3688-ea2":["/content---docs-doc-3688-ea2.130bfa01e5337dd7fda8.js"],"metadata---docs-doc-31-f-9-209":["/metadata---docs-doc-31-f-9-209.1b63522601a51de978c5.js"],"content---docs-mdx-442-733":["/content---docs-mdx-442-733.39c5c111a79caa37d9f5.js"],"metadata---docs-mdxb-5-a-c9d":["/metadata---docs-mdxb-5-a-c9d.bc21a09608afd0813445.js"],"component---theme-blog-list-pagea-6-a-7ba":[],"content---bloga-3-e-946":["/content---bloga-3-e-946.6f2c7baa65725ef7e56c.js"],"content---blogdb-9-70f":["/content---blogdb-9-70f.7ac8f752ce4444e0779d.js"],"content---blog-76-b-6a5":["/content---blog-76-b-6a5.fe52c1d22b8829b9cf2d.js"],"content---blog-33-c-c1d":["/content---blog-33-c-c1d.81600e2b3302c8feb0e5.js"],"content---blog-7-a-4-f34":["/content---blog-7-a-4-f34.28ad26dcb1d50029cb63.js"],"content---bloge-13-1a7":["/content---bloge-13-1a7.ffc401bdd7cf1ac0453b.js"],"content---blog-32-d-e46":["/content---blog-32-d-e46.68973ff3111266147c70.js"],"content---blog-093-e63":["/content---blog-093-e63.f22f9c358a919606e9c2.js"],"content---blogba-9-5f3":["/content---blogba-9-5f3.5575d8c3aae29c68bfb1.js"],"content---blog-021-c41":["/content---blog-021-c41.5d3309409f6ca8af33fc.js"],"metadata---blog-2-db-770":["/metadata---blog-2-db-770.b1427ef603bc29320686.js"],"content---blog-page-2350-fca":["/content---blog-page-2350-fca.f9aadc7efd6ea1ac79e6.js"],"metadata---blog-page-29-ac-584":["/metadata---blog-page-29-ac-584.1a0fe19ddccb4907b56b.js"],"component---theme-blog-tags-posts-page-687-b6c":[],"metadata---blog-tags-flutter-320-292":["/metadata---blog-tags-flutter-320-292.6a5f296055dcb1e2f7d4.js"],"metadata---blog-tags-widget-713-3a7":["/metadata---blog-tags-widget-713-3a7.0061166dd11f774b76c1.js"],"metadata---blog-tags-dartcbf-34e":["/metadata---blog-tags-dartcbf-34e.9c090bce02b326625a9d.js"],"metadata---blog-tags-platform-viewf-71-08e":["/metadata---blog-tags-platform-viewf-71-08e.5d8588a178071edad22e.js"],"metadata---blog-tags-video-577-edd":["/metadata---blog-tags-video-577-edd.f89bf05382224af56955.js"],"metadata---blog-tags-basicc-82-d21":["/metadata---blog-tags-basicc-82-d21.444cd0503cd5382343ad.js"],"component---theme-blog-tags-list-page-01-a-d0b":[],"tags---blog-tags-958-e2f":["/tags---blog-tags-958-e2f.83454201923b82e9c4c0.js"]};/*]]>*/</script>

<title data-react-helmet="true">Flutter Platform View 使用及原理简析</title>

<meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="viewport" content="width=device-width"/><meta data-react-helmet="true" property="og:title" content="Flutter Platform View 使用及原理简析"/><meta data-react-helmet="true" name="description" content="## 什么是 platform view？"/><meta data-react-helmet="true" property="og:description" content="## 什么是 platform view？"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/>

<link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.png"/>


<link rel="stylesheet" type="text/css" href="/main.d2d39918c98151667102.css" />

<link rel="stylesheet" type="text/css" href="/component---users-wangjianbing-project-fluttercn-dev-src-pages-index-js-8-f-8-fe8.26ff9bd308d6cd6104ae.css" />

<link rel="stylesheet" type="text/css" href="/docusaurus.021c9ec1e2a1ea4bcc15.css" />

</head>
<body >
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a aria-current="page" class="navbar__brand active" href="/"><img class="navbar__logo" src="/img/favicon.png" alt="Flutter-Fans Logo"/><strong>Flutter-Fans</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" label="Blog" position="left" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle displayOnlyInLargeViewport_1gtMWLzW"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_16vChPFo moon_1N64xB5S"></span></div><div class="react-toggle-track-x"><span class="toggle_16vChPFo sun_3CZP6R61"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"/></div></div></div><div role="presentation" class="navbar__sidebar__backdrop"></div><div class="navbar__sidebar"><div class="navbar__sidebar__brand"><a aria-current="page" class="navbar__brand active" href="/"><img class="navbar__logo" src="/img/favicon.png" alt="Flutter-Fans Logo"/><strong>Flutter-Fans</strong></a></div><div class="navbar__sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" label="Blog" position="left" href="/blog">Blog</a></li></ul></div></div></div></nav><div class="container margin-vert--xl"><div class="row"><div class="col col--8 col--offset-2"><div><header><h1 class="margin-bottom--xs"><a aria-current="page" class="active" href="/blog/2019/08/09/flutter-platform-view">Flutter Platform View 使用及原理简析</a></h1><div class="margin-bottom--sm"><small>August<!-- --> <!-- -->9<!-- -->, <!-- -->2019</small></div><div class="avatar margin-bottom--md"><a class="avatar__photo-link" href="https://github.com/loosaSH" target="_blank" rel="noreferrer noopener"><img class="avatar__photo" src="https://p5.ssl.qhimg.com/t01b6580ec3d65d7b7f.png" alt="loosaSH"/></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/loosaSH" target="_blank" rel="noreferrer noopener">loosaSH</a></h4><small class="avatar__subtitle">A flutter fans</small></div></div></header><article class="markdown"><h2><a aria-hidden="true" class="anchor" id="什么是-platform-view？"></a><a aria-hidden="true" class="hash-link" href="#什么是-platform-view？">#</a>什么是 platform view？</h2><p>由于 Flutter 诞生于 Android 、iOS 非常成熟的时代背景，为了能让一些现有的 native 控件直接引用到 Flutter app 中，Flutter 团队提供了 AndroidView 、UIKitView 两个 widget 来满足需求，比如说 Flutter 中的 Webview、MapView，暂时无需使用 Flutter 重新开发一套。</p><p>其实 platform view 就是 AndroidView 和 UIKitView 的总称，允许将 native view 嵌入到了 flutter widget 体系中，完成 Datr 代码对 native view 的控制。</p><h2><a aria-hidden="true" class="anchor" id="简单使用"></a><a aria-hidden="true" class="hash-link" href="#简单使用">#</a>简单使用</h2><p><em>此处仅是简单使用，有很多不合理的代码，目的仅是让初学者能完成展示，后面会有具体的 framework 代码分析，及官方维护的 platform view 的分析。</em></p><p>先看一下效果吧</p><p><img src="http://p0.qhimg.com/t013d5e6465486ce0e6.png"/></p><p><img src="http://p0.qhimg.com/t012a61a67eb82cab12.png"/></p><p>存在与 native 交互的代码，建议用一个 plugin 来实现内部逻辑。</p><blockquote><p>Plugin: exposing an Android or iOS API for developers</p></blockquote><h3><a aria-hidden="true" class="anchor" id="flutter-侧"></a><a aria-hidden="true" class="hash-link" href="#flutter-侧">#</a>Flutter 侧</h3><p>创建 Flutter plugin （建议使用 Android Studio），如果使用命令行，可以执行如下命令：</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-bash codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">flutter create --org net.loosash --template </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> plugin share_platform_plugin</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>接下来在我们的插件工程里创建一个 widget 用来包裹 platform view。便于使用</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-dart codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">import &#x27;package:flutter/cupertino.dart&#x27;;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">import &#x27;package:flutter/foundation.dart&#x27;;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">import &#x27;package:flutter/services.dart&#x27;;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">/// 这里使用了 statelessWidget</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">class PlatformTextWidget extends StatelessWidget {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  PlatformTextWidget({this.text});</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  final String text;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  @override</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  Widget build(BuildContext context) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // 根据运行平台判断执行代码</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if (defaultTargetPlatform == TargetPlatform.android) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      return AndroidView(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        // 在 native 中的唯一标识符，需要与 native 侧的值相同</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        viewType: &quot;platform_text_view&quot;,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        // 在创建 AndroidView 的同时，可以传递参数</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        creationParams: &lt;String, dynamic&gt;{&quot;text&quot;: text},</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        // 用来编码 creationParams 的形式，可选 [StandardMessageCodec], [JSONMessageCodec], [StringCodec], or [BinaryCodec]</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        // 如果存在 creationParams，则该值不能为null</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        creationParamsCodec: const StandardMessageCodec(),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      );</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    } else if (defaultTargetPlatform == TargetPlatform.iOS) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      return UiKitView(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        viewType: &quot;platform_text_view&quot;,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        creationParams: &lt;String, dynamic&gt;{&quot;text&quot;: text},</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        creationParamsCodec: const StandardMessageCodec(),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      );</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    } else {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      return Text(&quot;不支持的平台&quot;);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><h3><a aria-hidden="true" class="anchor" id="ios-侧"></a><a aria-hidden="true" class="hash-link" href="#ios-侧">#</a>iOS 侧</h3><p>在编辑Xcode中的iOS平台代码之前，首先确保代码至少已构建过一次。在创建的 plugin/example 目录下执行 build，如下：</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-bash codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token function" style="color:rgb(130, 170, 255)">cd</span><span class="token plain"> share_platform_plugin/example</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">flutter build ios --no-codesign</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">或者执行 pod </span><span class="token function" style="color:rgb(130, 170, 255)">install</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>然后使用 Xcode 打开 share_platform_plugin/example/ios/Runner.xcworkspace，plugin 相关的代码目录很深，在 Pods/Development Pods/share_platform_plugin 内部，具体找到 SharePlatformPlugin.h 与 SharePlatformPlugin.m 目录即位我们操作的目录。</p><p>接下来我们先创建需要展示的 View ，这里仅以一个 UILabel 为例。</p><p>IOSTextView.h</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-objective-c codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">#import &lt;Foundation/Foundation.h&gt;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">#import &lt;Flutter/Flutter.h&gt;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">NS_ASSUME_NONNULL_BEGIN</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">@interface IOSTextView : NSObject&lt;FlutterPlatformView&gt;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">- (instancetype)initWithFrame:(CGRect)frame</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                   viewIdentifier:(int64_t)viewId</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                        arguments:(id _Nullable)args</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                  binaryMessenger:(NSObject&lt;FlutterBinaryMessenger&gt;*)messenger;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">@end</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">NS_ASSUME_NONNULL_END</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>IOSTextView.m</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-objective-c codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">#import &lt;Foundation/Foundation.h&gt;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">#import &quot;IOSTextView.h&quot;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">@implementation IOSTextView{</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    int64_t _viewId;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    FlutterMethodChannel* _channel;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    UILabel * _uiLabel;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">- (instancetype)initWithFrame:(CGRect)frame viewIdentifier:(int64_t)viewId arguments:(id)args binaryMessenger:(NSObject&lt;FlutterBinaryMessenger&gt; *)messenger{</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    </span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    NSString *text = @&quot;iOS端UILabel&quot;;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if ([args isKindOfClass:[NSDictionary class]]) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        NSDictionary *params = (NSDictionary *)args;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        if([[params allKeys] containsObject:@&quot;text&quot;]){</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            if ([[params valueForKey:@&quot;text&quot;] isKindOfClass:[NSString class]]) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                text= [params valueForKey:@&quot;text&quot;];</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    _uiLabel = [[UILabel alloc] initWithFrame:CGRectMake(0, 0, 100, 100)];</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    _uiLabel.textAlignment = NSTextAlignmentCenter;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    _uiLabel.text = text;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    _uiLabel.font = [UIFont systemFontOfSize:30];</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    return self;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">-(UIView *)view{</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    return _uiLabel;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">@end</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>然后创建 FlutterPlatformViewFactory</p><p>SharePlatformViewFactory.h</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-objective-c codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">#import &lt;Foundation/Foundation.h&gt;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">#import &lt;Flutter/Flutter.h&gt;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">NS_ASSUME_NONNULL_BEGIN</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">@interface SharePlatformViewFactory : NSObject&lt;FlutterPlatformViewFactory&gt;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">- (instancetype)initWithMessenger:(NSObject&lt;FlutterBinaryMessenger&gt;*)messager;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">-(NSObject&lt;FlutterMessageCodec&gt; *)createArgsCodec;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">-(NSObject&lt;FlutterPlatformView&gt; *)createWithFrame:(CGRect)frame viewIdentifier:(int64_t)viewId arguments:(id)args;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">@end</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">NS_ASSUME_NONNULL_END</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>SharePlatformViewFactory.m</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-objective-c codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">#import &quot;SharePlatformViewFactory.h&quot;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">#import &quot;IOSTextView.h&quot;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">@implementation SharePlatformViewFactory{</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    NSObject&lt;FlutterBinaryMessenger&gt;*_messenger;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">- (instancetype)initWithMessenger:(NSObject&lt;FlutterBinaryMessenger&gt; *)messager{</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    self = [super init];</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if (self) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        _messenger = messager;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    return self;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">-(NSObject&lt;FlutterMessageCodec&gt; *)createArgsCodec{</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    return [FlutterStandardMessageCodec sharedInstance];</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">-(NSObject&lt;FlutterPlatformView&gt; *)createWithFrame:(CGRect)frame viewIdentifier:(int64_t)viewId arguments:(id)args{</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    IOSTextView *iosTextView = [[IOSTextView alloc] initWithFrame:frame viewIdentifier:viewId arguments:args binaryMessenger:_messenger];</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    return iosTextView;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">@end</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>接下来在 SharePlatformPlugin.m 中添加我们创建 SharePlatformViewFactory 的注册。</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-objective-c codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">#import &quot;SharePlatformPlugin.h&quot;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">#import &quot;SharePlatformViewFactory.h&quot;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">@implementation SharePlatformPlugin</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">+ (void)registerWithRegistrar:(NSObject&lt;FlutterPluginRegistrar&gt;*)registrar {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  FlutterMethodChannel* channel = [FlutterMethodChannel</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      methodChannelWithName:@&quot;share_platform_plugin&quot;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            binaryMessenger:[registrar messenger]];</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  SharePlatformPlugin* instance = [[SharePlatformPlugin alloc] init];</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  [registrar addMethodCallDelegate:instance channel:channel];</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // 添加注册我们创建的 view ，注意这里的 withId 需要和 flutter 侧的值相同</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    [registrar registerViewFactory:[[SharePlatformViewFactory alloc] initWithMessenger:registrar.messenger] withId:@&quot;platform_text_view&quot;];</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">- (void)handleMethodCall:(FlutterMethodCall*)call result:(FlutterResult)result {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  if ([@&quot;getPlatformVersion&quot; isEqualToString:call.method]) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    result([@&quot;iOS &quot; stringByAppendingString:[[UIDevice currentDevice] systemVersion]]);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  } else {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    result(FlutterMethodNotImplemented);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">@end</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>最后，还需要在 Flutter 项目中的 ios/Runner/info.plist 中增加，就是运行 flutter 的项目</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-undefined codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">&lt;key&gt;io.flutter.embedded_views_preview&lt;/key&gt;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    &lt;true/&gt;</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>iOS侧就完成了。</p><h3><a aria-hidden="true" class="anchor" id="android-侧"></a><a aria-hidden="true" class="hash-link" href="#android-侧">#</a>Android 侧</h3><p>直接使用 Android Studio 打开 plugin 中的 android 目录，share_platform_plugin/android</p><p>接下来我们先创建需要展示的 View ，这里仅以一个 TextView 为例。</p><p>AndroidTextView.kt</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-kotlin codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">class AndroidTextView(context: Context,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                      messenger: BinaryMessenger,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                      id: Int?,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">                      params: Map&lt;String, Any&gt;?) : PlatformView {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    private val mAndroidTextView: TextView = TextView(context)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    init {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        val text = params?.get(&quot;text&quot;) as CharSequence?</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        mAndroidTextView.text = if (text == null) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            text</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        } else {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            &quot;android端TextView&quot;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        </span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        mAndroidTextView.textSize = 30f</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    override fun getView(): View = mAndroidTextView</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    override fun dispose() {}</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>创建 SharePlatformViewFactory.kt</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-kotlin codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">class SharePlatformViewFactory(private val messenger: BinaryMessenger)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    : PlatformViewFactory(StandardMessageCodec.INSTANCE) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    </span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    override fun create(context: Context, id: Int, args: Any?): PlatformView {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        val params = args?.let { args as Map&lt;String, Any&gt; }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        return AndroidTextView(context, messenger, id, params)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>最后，在 SharePlatformPlugin 中添加我们创建 SharePlatformViewFactory 的注册。</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-kotlin codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">class SharePlatformPlugin: MethodCallHandler {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  companion object {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    @JvmStatic</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    fun registerWith(registrar: Registrar) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      val channel = MethodChannel(registrar.messenger(), &quot;share_platform_plugin&quot;)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      channel.setMethodCallHandler(SharePlatformPlugin())</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      // 添加注册我们创建的 view ，注意这里的 withId 需要和 flutter 侧的值相同</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      registrar.platformViewRegistry().registerViewFactory(&quot;platform_text_view&quot;, SharePlatformViewFactory(registrar.messenger()))</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  override fun onMethodCall(call: MethodCall, result: Result) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if (call.method == &quot;getPlatformVersion&quot;) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      result.success(&quot;Android ${android.os.Build.VERSION.RELEASE}&quot;)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    } else {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      result.notImplemented()</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>这样 Andorid 侧的代码就完成了。</p><h3><a aria-hidden="true" class="anchor" id="flutter项目中的使用"></a><a aria-hidden="true" class="hash-link" href="#flutter项目中的使用">#</a>Flutter项目中的使用</h3><p>在 Flutter 工程中 pubspec.yaml 引入该 plugin 。</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-yaml codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token key atrule">dependencies</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">flutter</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">sdk</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> flutter</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">cupertino_icons</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ^0.1.2</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># 下面是对我们新建插件的依赖</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">share_platform_plugin</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ../share_platform_plugin</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>执行 Packages get</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-bash codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">flutter package get</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>在需要展示的地方和正常的 widget 一样使用我们自己创建的 PlatformTextWidget</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-dart codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">import &#x27;package:flutter/foundation.dart&#x27;;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">import &#x27;package:flutter/material.dart&#x27;;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">import &#x27;package:flutter/services.dart&#x27;;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">import &#x27;package:share_platform_plugin/widget/platform_text_widget.dart&#x27;;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">class TextPage extends StatelessWidget {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  @override</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  Widget build(BuildContext context) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    return Scaffold(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      appBar: AppBar(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        title: Text(&quot;native text&quot;),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      ),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      body: SafeArea(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        child: Column(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">          children: &lt;Widget&gt;[</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            Text(&quot;这里是flutter的Text&quot;),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            Expanded(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">              child: PlatformTextWidget(text:&quot;123&quot;),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            ),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">            Text(&quot;这里是flutter的Text&quot;),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">          ],</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        ),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      ),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    );</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><h2><a aria-hidden="true" class="anchor" id="发现问题"></a><a aria-hidden="true" class="hash-link" href="#发现问题">#</a>发现问题</h2><p>如果上面的代码你自己写一遍，你就会发现存在很多的问题。</p><ol><li>id 在对应的端上没有被使用，可以用来做什么？</li><li>这里的 PlatformTextWidget 被 Expanded 包裹着，如果不包裹就会出现超出边界的错误，那么这个 Widget 的大小是怎么控制的呢？</li><li>platform view 的绘制是在 native 侧完成的还是在 flutter 侧完成的呢？</li></ol><p>带着问题，我们看一遍源码，看看是否能找到相关的答案。</p><h2><a aria-hidden="true" class="anchor" id="源码分析"></a><a aria-hidden="true" class="hash-link" href="#源码分析">#</a>源码分析</h2><p>先来看看 AndroidView 吧</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-dart codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">// 继承了 StatefulWidget</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">class AndroidView extends StatefulWidget {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  const AndroidView({</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    Key key,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    @required this.viewType,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    this.onPlatformViewCreated,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    this.hitTestBehavior = PlatformViewHitTestBehavior.opaque,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    this.layoutDirection,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    this.gestureRecognizers,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    this.creationParams,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    this.creationParamsCodec,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }) : assert(viewType != null),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">       assert(hitTestBehavior != null),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">       assert(creationParams == null || creationParamsCodec != null),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">       super(key: key);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  /// 嵌入Android视图类型的唯一标识符 </span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  final String viewType;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  /// platform view 创建完成的回调</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  final PlatformViewCreatedCallback onPlatformViewCreated;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    /// hit测试期间的行为</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  final PlatformViewHitTestBehavior hitTestBehavior;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  /// 视图的文本方向</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  final TextDirection layoutDirection;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  </span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  /// 用于处理事件冲突，对事件进行分发管理相关操作</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  final Set&lt;Factory&lt;OneSequenceGestureRecognizer&gt;&gt; gestureRecognizers;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  /// 传给 Android 视图的参数，在 Android 视图构造的时候使用</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  final dynamic creationParams;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  /// 对 creationParams 参数传递时进行的编码规则，如果 creationParams 不为 null，该值必须不为 null</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  final MessageCodec&lt;dynamic&gt; creationParamsCodec;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  @override</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  State&lt;AndroidView&gt; createState() =&gt; _AndroidViewState();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>有一些需要注意的点</p><ul><li>AndroidView 仅支持 Android API 20 及以上；</li><li>在Flutter 中使用 AndroidView 对性能的开销比较大，应该尽可能的避免使用；</li><li>可以把它当作一个 Flutter 的 wedget 一样的使用。</li></ul><p>接下来我们看一下这个 State 对象，关于生命周期的知识，这里给出链接：</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-dart codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">class _AndroidViewState extends State&lt;AndroidView&gt; {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 用于区分不同的 View 来接收不同的操作指令，可以说不同的 id 代表着不同的 view</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 在_createNewAndroidView方法中被赋值</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 触发条件：1、在 didChangeDependencies 生命周期中第一次初始化触发</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 2、didUpdateWidget 生命周期中 传入的viewType 发生改变时触发</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  int _id;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // AndroidView的控制器，和 _id 的赋值场景相同</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  AndroidViewController _controller;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 布局方向，widget 传入</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  TextDirection _layoutDirection;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 被初始化的标识，保证_createNewAndroidView()操作以及_focusNode被操作一次</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  bool _initialized = false;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 获取键盘焦点及事件的相关类</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  FocusNode _focusNode;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 创建一个空的set集合，如果没有传入gestureRecognizers，则使用该空集合</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  static final Set&lt;Factory&lt;OneSequenceGestureRecognizer&gt;&gt; _emptyRecognizersSet =</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    &lt;Factory&lt;OneSequenceGestureRecognizer&gt;&gt;{};</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // build 方法，包裹了一层 Focus 用来处理焦点的问题，内部真实使用的是 _AndroidPlatformView，后面单独分析_AndroidPlatformView</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  @override</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  Widget build(BuildContext context) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    return Focus(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      focusNode: _focusNode,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      onFocusChange: _onFocusChange,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      child: _AndroidPlatformView(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        controller: _controller,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        hitTestBehavior: widget.hitTestBehavior,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        gestureRecognizers: widget.gestureRecognizers ?? _emptyRecognizersSet,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      ),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    );</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 保证操作仅执行一次</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  void _initializeOnce() {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if (_initialized) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      return;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    _initialized = true;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    _createNewAndroidView();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    _focusNode = FocusNode(debugLabel: &#x27;AndroidView(id: $_id)&#x27;);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // didChangeDependencies 生命周期回调</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  @override</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  void didChangeDependencies() {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    super.didChangeDependencies();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    final TextDirection newLayoutDirection = _findLayoutDirection();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // 布局方向调教，是否有改变</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    final bool didChangeLayoutDirection = _layoutDirection != newLayoutDirection;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    _layoutDirection = newLayoutDirection;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    </span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        // 会多次回调该生命周期，但是保证关键操作仅执行一次</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    _initializeOnce();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // 根据条件判断是否需要重制布局方向</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if (didChangeLayoutDirection) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      _controller.setLayoutDirection(_layoutDirection);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // didUpdateWidget 生命周期回调</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  @override</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  void didUpdateWidget(AndroidView oldWidget) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    super.didUpdateWidget(oldWidget);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    final TextDirection newLayoutDirection = _findLayoutDirection();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    final bool didChangeLayoutDirection = _layoutDirection != newLayoutDirection;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    _layoutDirection = newLayoutDirection;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // 根据viewType是否相同来确定是否需要重新创建 AndroidView，生成新的id</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if (widget.viewType != oldWidget.viewType) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      _controller.dispose();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      _createNewAndroidView();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      return;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // 布局方向相关</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if (didChangeLayoutDirection) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      _controller.setLayoutDirection(_layoutDirection);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  TextDirection _findLayoutDirection() {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    assert(widget.layoutDirection != null || debugCheckHasDirectionality(context));</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    return widget.layoutDirection ?? Directionality.of(context);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 回收资源</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  @override</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  void dispose() {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    _controller.dispose();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    super.dispose();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 关键的方法，生成 _id 及 _controller,用于传递给_AndroidPlatformView</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  void _createNewAndroidView() {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // 每次对 _id 进行自增，保证唯一性。</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    _id = platformViewsRegistry.getNextPlatformViewId();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // initAndroidView 构造了一个 _controller，将参数端都交给 _controller 保管</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    _controller = PlatformViewsService.initAndroidView(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      id: _id,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      viewType: widget.viewType,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      layoutDirection: _layoutDirection,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      creationParams: widget.creationParams,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      creationParamsCodec: widget.creationParamsCodec,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      onFocus: () {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        _focusNode.requestFocus();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    );</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // 添加回调，给开发者使用</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if (widget.onPlatformViewCreated != null) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      _controller.addOnPlatformViewCreatedListener(widget.onPlatformViewCreated);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 焦点变更</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  void _onFocusChange(bool isFocused) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if (!_controller.isCreated) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      return;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if (!isFocused) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      _controller.clearFocus().catchError((dynamic e) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">       if (e is MissingPluginException) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">         return;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">       }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      });</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      return;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // 通过 flutter engin 来实实现焦点变更对 native view 的处理</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    SystemChannels.textInput.invokeMethod&lt;void&gt;(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      &#x27;TextInput.setPlatformViewClient&#x27;,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      _id,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    ).catchError((dynamic e) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      if (e is MissingPluginException) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        return;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    });</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p><strong>小结一下</strong>：</p><p><strong>我们解决解决了如下问题</strong>：</p><p>这里我们发现了 id 的作用，当创建的时候，分配一个 id，在 viewType 改变的时候从新分配，其实就是对应 native 侧创建 view 的时候，所以可以通过 id 来保证通过 channel 来和不同 view 进行通信，解决 view 的区分处理。</p><p><strong>我们又遇到了新的问题</strong>：</p><p>AndroidViewController、_AndroidPlatformView都做了什么？</p><p>我们先来分析一下 AndroidViewController 会对我们上面的问题和 _AndroidPlatformView 的分析有帮助。</p><p>这里会有 Texture 纹理相关的知识，这里不做分析，有兴趣可以查看一下相关文章</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-dart codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">// AndroidViewController 是通过 PlatformViewsService.initAndroidView 方法创建的，上面有的分析过程里有</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">class AndroidViewController {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  AndroidViewController._(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    this.id,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    String viewType,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    dynamic creationParams,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    MessageCodec&lt;dynamic&gt; creationParamsCodec,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    TextDirection layoutDirection,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  ) : assert(id != null),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      assert(viewType != null),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      assert(layoutDirection != null),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      assert(creationParams == null || creationParamsCodec != null),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      _viewType = viewType,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      _creationParams = creationParams,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      _creationParamsCodec = creationParamsCodec,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      _layoutDirection = layoutDirection,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      _state = _AndroidViewState.waitingForSize;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 对应了很多 android 中的点击事件 MotionEvent 相关</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // [MotionEvent.ACTION_DOWN]</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  static const int kActionDown =  0;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // [MotionEvent.ACTION_UP]</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  static const int kActionUp =  1;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // [MotionEvent.ACTION_MOVE]</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  static const int kActionMove = 2;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // [MotionEvent.ACTION_CANCEL]</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  static const int kActionCancel = 3;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // [MotionEvent.ACTION_POINTER_DOWN]</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  static const int kActionPointerDown =  5;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // [MotionEvent.ACTION_POINTER_UP]</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  static const int kActionPointerUp =  6;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 布局方向相关</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // [View.LAYOUT_DIRECTION_LTR]</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  static const int kAndroidLayoutDirectionLtr = 0;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // [View.LAYOUT_DIRECTION_RTL]</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  static const int kAndroidLayoutDirectionRtl = 1;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 标识 id 上面已经分析过了</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  final int id;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // native 侧注册的 viewType 字段</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  final String _viewType;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 在创建 andorid 端 view 的时候（下文 _create方法），返回_textureId。</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 该 id 是在 native 侧渲染完成后绘图数据对应的id，可以直接在GPU中找到并直接使用</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // Flutter 的 Framework 层最后会递交给 Engine 层一个 layerTree ，包含了此处的 _textureId，最终在绘制的时候，skia 会直接在 GPU 中根据 textureId 找到相应的绘制数据，并将其绘制到屏幕上。</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  int _textureId;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // _textureId 的 get 方法</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  int get textureId =&gt; _textureId;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  TextDirection _layoutDirection;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 枚举状态</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  _AndroidViewState _state;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 参数</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  dynamic _creationParams;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 编码类</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  MessageCodec&lt;dynamic&gt; _creationParamsCodec;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 回调集合</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  final List&lt;PlatformViewCreatedCallback&gt; _platformViewCreatedCallbacks = &lt;PlatformViewCreatedCallback&gt;[];</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  /// 获取 view 的 create 状态</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  bool get isCreated =&gt; _state == _AndroidViewState.created;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  void addOnPlatformViewCreatedListener(PlatformViewCreatedCallback listener) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    assert(listener != null);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    assert(_state != _AndroidViewState.disposed);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    _platformViewCreatedCallbacks.add(listener);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  void removeOnPlatformViewCreatedListener(PlatformViewCreatedCallback listener) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    assert(_state != _AndroidViewState.disposed);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    _platformViewCreatedCallbacks.remove(listener);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // Disposes the Android view.</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 通过 engine 调用了 native 的 dispose 方法、清空回调集合、disposed 当前 widget 的 state</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  Future&lt;void&gt; dispose() async {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if (_state == _AndroidViewState.creating || _state == _AndroidViewState.created)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      await SystemChannels.platform_views.invokeMethod&lt;void&gt;(&#x27;dispose&#x27;, id);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    _platformViewCreatedCallbacks.clear();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    _state = _AndroidViewState.disposed;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 设置 Android View 的大小，通过 engine 调用了 native 的 resize 方法</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  Future&lt;void&gt; setSize(Size size) async {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    assert(_state != _AndroidViewState.disposed, &#x27;trying to size a disposed Android View. View id: $id&#x27;);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    assert(size != null);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    assert(!size.isEmpty);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if (_state == _AndroidViewState.waitingForSize)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      return _create(size);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    await SystemChannels.platform_views.invokeMethod&lt;void&gt;(&#x27;resize&#x27;, &lt;String, dynamic&gt;{</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      &#x27;id&#x27;: id,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      &#x27;width&#x27;: size.width,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      &#x27;height&#x27;: size.height,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    });</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 通过 engine 调用了 native 的 setDirection 方法，设置 Android view 方向</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  Future&lt;void&gt; setLayoutDirection(TextDirection layoutDirection) async {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    assert(_state != _AndroidViewState.disposed,&#x27;trying to set a layout direction for a disposed UIView. View id: $id&#x27;);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if (layoutDirection == _layoutDirection)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      return;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    assert(layoutDirection != null);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    _layoutDirection = layoutDirection;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if (_state == _AndroidViewState.waitingForSize)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      return;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    await SystemChannels.platform_views.invokeMethod&lt;void&gt;(&#x27;setDirection&#x27;, &lt;String, dynamic&gt;{</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      &#x27;id&#x27;: id,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      &#x27;direction&#x27;: _getAndroidDirection(layoutDirection),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    });</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 通过 engine 调用了 native 的 clearFocus 方法，清除焦点</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  Future&lt;void&gt; clearFocus() {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if (_state != _AndroidViewState.created) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      return null;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    return SystemChannels.platform_views.invokeMethod&lt;void&gt;(&#x27;clearFocus&#x27;, id);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 获得布局方向</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  static int _getAndroidDirection(TextDirection direction) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    assert(direction != null);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    switch (direction) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      case TextDirection.ltr:</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        return kAndroidLayoutDirectionLtr;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      case TextDirection.rtl:</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        return kAndroidLayoutDirectionRtl;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    return null;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 通过 engine 调用 native 的 touch 方法，将事件发送给 android view 处理</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  Future&lt;void&gt; sendMotionEvent(AndroidMotionEvent event) async {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    await SystemChannels.platform_views.invokeMethod&lt;dynamic&gt;(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        &#x27;touch&#x27;,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        event._asList(id),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    );</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  /// Creates a masked Android MotionEvent action value for an indexed pointer.</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  static int pointerAction(int pointerId, int action) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    return ((pointerId &lt;&lt; 8) &amp; 0xff00) | (action &amp; 0xff);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 真正创建 view 的方法，也是通过 engine 调用 native 的 create 方法，传入了 width 和 height</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  Future&lt;void&gt; _create(Size size) async {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    final Map&lt;String, dynamic&gt; args = &lt;String, dynamic&gt;{</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      &#x27;id&#x27;: id,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      &#x27;viewType&#x27;: _viewType,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      &#x27;width&#x27;: size.width,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      &#x27;height&#x27;: size.height,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      &#x27;direction&#x27;: _getAndroidDirection(_layoutDirection),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    };</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    if (_creationParams != null) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      final ByteData paramsByteData = _creationParamsCodec.encodeMessage(_creationParams);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      args[&#x27;params&#x27;] = Uint8List.view(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        paramsByteData.buffer,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        0,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        paramsByteData.lengthInBytes,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      );</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    _textureId = await SystemChannels.platform_views.invokeMethod(&#x27;create&#x27;, args);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    _state = _AndroidViewState.created;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    for (PlatformViewCreatedCallback callback in _platformViewCreatedCallbacks) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      // 遍历、回调</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      callback(id);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>我们看到了 view 的大小由 _create 方法传入，那传入的值是怎么获得的呢？我们先把还没分析的 _AndroidPlatformView 看完再下结论。</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-dart codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">class _AndroidPlatformView extends LeafRenderObjectWidget {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 将 controller 传进来了，具体没做太多的操作，主要还是通过 controller 来实现的。</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  const _AndroidPlatformView({</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    Key key,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    @required this.controller,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    @required this.hitTestBehavior,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    @required this.gestureRecognizers,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }) : assert(controller != null),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">       assert(hitTestBehavior != null),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">       assert(gestureRecognizers != null),</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">       super(key: key);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  final AndroidViewController controller;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  final PlatformViewHitTestBehavior hitTestBehavior;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  final Set&lt;Factory&lt;OneSequenceGestureRecognizer&gt;&gt; gestureRecognizers;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  // 需要注意的是这两个方法，这里重写了 createRenderObject 方法。</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  @override</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  RenderObject createRenderObject(BuildContext context) =&gt;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      RenderAndroidView(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        viewController: controller,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        hitTestBehavior: hitTestBehavior,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        gestureRecognizers: gestureRecognizers,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">      );</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  @override</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  void updateRenderObject(BuildContext context, RenderAndroidView renderObject) {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    renderObject.viewController = controller;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    renderObject.hitTestBehavior = hitTestBehavior;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    renderObject.updateGestureRecognizers(gestureRecognizers);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>我这里先假设大家都知道 Widget、Element、RenderObject之间的关系，如果不是很清晰，这篇文章里有详细的介绍。</p><p>RenderObject 的最终大小的确定有两种情况，一个是由父节点所指定，一个是根据自己的情况确定。默认的 RenderObject 中有一个 sizedByParent 属性，默认为 false，即根据自身大小确定。这里指定了 RenderObject 为 RenderAndroidView ，我们来看一下这个类，这里就不一行一行的分析了，我们把重点提出来。</p><pre class="mdxCodeBlock_iHAB0Zg7"><div class="codeBlockWrapper_2QGZbNRm"><pre class="prism-code language-dart codeBlock_19pQyIiL" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">@override</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">  bool get sizedByParent =&gt; true;</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYjXM7E">Copy</button></div></pre><p>所以我们可以得出结论了。</p><p><strong>再小结一下</strong>：</p><p><strong>我们解决解决了剩下的问题</strong>：</p><p>1、我们了解了 AndroidViewController、_AndroidPlatformView 都做了什么。</p><p>2、AndroidView 的大小是由父节点的大小去定的所以上面使用 Expanded 包裹则可以生效，如果不进行包裹，则大小为父控件大小，在 Column 中会出现问题。当 Widget size 小于 View size，Flutter 会进行裁剪。当 Widget  size 大于 View size 时，多出来的位置会被背景填充。在 Android 侧，实现了 PlatformView 的 View 会被包裹在 FrameLayout 中，可以对 View 的绘制添加监听，打印出 View 的 parent；</p><p>3、platform view 是在 native 侧渲染的，返回给 Flutter 侧一个 _textureId ，通过这个 id Flutter 将 View 直接展示出来。这部分也说明了为什么 platform view 在 Flutter 中的性能开销比较大，整个过程数据需要从 GPU -&gt; CPU -&gt; GPU，这部分的代价是比较大的。</p><h2><a aria-hidden="true" class="anchor" id="如何开发一个-platform-view"></a><a aria-hidden="true" class="hash-link" href="#如何开发一个-platform-view">#</a>如何开发一个 platform view</h2><p>其实 Flutter 官方维护了一些 plugin，链接如下：</p><blockquote><p> <a href="https://github.com/flutter/plugins">https://github.com/flutter/plugins</a></p></blockquote><p>其中的 <a href="https://github.com/flutter/plugins/blob/master/packages/webview_flutter">webview_flutter</a> 、<a href="https://github.com/flutter/plugins/blob/master/packages/google_maps_flutter">google_maps_flutter</a> 就是通过 platform view，就是一个很好的 demo 。</p><p>参考资料：</p><p>在Flutter中嵌入Native组件的正确姿势<a href="https://yq.aliyun.com/articles/669831?utm_content=m_1000024586">https://yq.aliyun.com/articles/669831?utm_content=m_1000024586</a></p><p>github:Flutter Plugin <a href="https://github.com/flutter/plugins">https://github.com/flutter/plugins</a></p><p>Flutter 从加载到显示<a href="https://mp.weixin.qq.com/s/ncViI0KGikPUIZ7BlEHGOA">https://mp.weixin.qq.com/s/ncViI0KGikPUIZ7BlEHGOA</a></p><p>Flutter外接纹理<a href="https://zhuanlan.zhihu.com/p/42566807">https://zhuanlan.zhihu.com/p/42566807</a></p><p>Flutter State的生命周期<a href="https://www.jianshu.com/p/f39cf2f7ad78">https://www.jianshu.com/p/f39cf2f7ad78</a></p></article><div class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/flutter">flutter</a><a class="margin-horiz--sm" href="/blog/tags/platform-view">platform-view</a></div><div class="col text--right"></div></div></div><div class="margin-vert--xl"><nav class="pagination-nav"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2019/08/11/flutter-render"><h5 class="pagination-nav__link--sublabel">Previous Post</h5><h4 class="pagination-nav__link--label">« <!-- -->Flutter 从加载到显示</h4></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2019/07/29/flutter-image"><h5 class="pagination-nav__link--sublabel">Next Post</h5><h4 class="pagination-nav__link--label">Flutter组件之Image<!-- --> »</h4></a></div></nav></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="text--center">Copyright © 2019 Flutter-Fans. Built with Docusaurus.</div></div></footer>
</div>

<script type="text/javascript" src="/runtime~main.5798b59511625407e92d.js"></script>

<script type="text/javascript" src="/main.d2d39918c98151667102.js"></script>

<script type="text/javascript" src="/vendors.9aee166e5353e980d8e9.js"></script>

<script type="text/javascript" src="/react-helmet.a23111244c2da4702cb2.js"></script>

<script type="text/javascript" src="/prism-react-renderer.3b4b4d7a3b41b05b8b8a.js"></script>

<script type="text/javascript" src="/component---users-wangjianbing-project-fluttercn-dev-src-pages-index-js-8-f-8-fe8.26ff9bd308d6cd6104ae.js"></script>

<script type="text/javascript" src="/docusaurus.021c9ec1e2a1ea4bcc15.js"></script>

<script type="text/javascript" src="/content---blog-2019-08-09-flutter-platform-view-31-b-d5a.17a5ea4827cb268e132f.js"></script>

<script type="text/javascript" src="/nextItem---blog-2019-08-11-flutter-renderf-90-acb.02dd3735024dd8fe4d58.js"></script>

<script type="text/javascript" src="/nextItem---blog-2019-08-14-flutter-platform-channel-7-ed-a0b.79d39fc077891d5e758e.js"></script>

<script type="text/javascript" src="/nextItem---blog-2019-08-09-flutter-platform-view-09-e-95e.094efbc8d3ec82c87fc9.js"></script>

</body>
</html>